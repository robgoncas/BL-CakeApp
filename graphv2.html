<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tableau de Bord - Analyse des Ventes</title>
    <!-- Material Icons & Font Awesome -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        /* === FONT === */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
    
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f7fa;
            color: #333;
        }
    
        /* === GLOBAL CONTAINER === */
        .container {
            max-width: 1400px;
            margin: auto;
            padding: 20px;
        }
    
        /* === COLORS === */
        :root {
            --primary-color: #2E7D32;
            --secondary-color: #1E88E5;
            --accent-color: #FFB300;
            --background-light: #FFFFFF;
            --background-alt: #FAFAFA;
            --text-dark: #212121;
            --text-muted: #757575;
            --border-color: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.1);
        }
    
        /* === HEADER / TOP BAR === */
        .mdc-top-app-bar {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }
    
        .mdc-top-app-bar__title {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
    
        /* === CARDS === */
        .mdc-card {
            background-color: var(--background-light);
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            width: 100%;
            border: 1px solid var(--border-color);
        }
    
        .mdc-card__title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }
    
        /* === CHART CONTAINERS === */
        .chart-container {
            position: relative;
            height: 450px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        /* === FILTERS === */
        .filter-container {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .filter-item {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        .filter-item label {
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .filter-item select, .filter-item input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--background-light);
            font-size: 0.95rem;
        }
        
        /* === KPI CARDS === */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-color);
        }
        
        .kpi-title {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        
        .kpi-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        /* === RESPONSIVE === */
        @media (max-width: 992px) {
            .chart-container {
                height: 350px;
            }
            
            .filter-container {
                gap: 15px;
            }
            
            .filter-item {
                min-width: 160px;
            }
        }
        
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
            
            .kpi-container {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
            
            .kpi-value {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 576px) {
            .container {
                padding: 15px;
            }
            
            .mdc-card {
                padding: 20px 15px;
            }
            
            .filter-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .filter-item {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <header class="mdc-top-app-bar">
        <div class="mdc-top-app-bar__row">
            <section class="mdc-top-app-bar__section">
                <span class="mdc-top-app-bar__title"><i class="fas fa-chart-line"></i> Tableau de Bord des Ventes</span>
            </section>
        </div>
    </header>
    
    <main class="container">
        <!-- File Upload Section -->
        <div class="mdc-card">
            <h2 class="mdc-card__title"><i class="fas fa-file-import"></i> Importation des Données</h2>
            <div class="filter-container">
                <div class="filter-item">
                    <label for="file-input">Sélectionner fichiers JSON</label>
                    <input type="file" id="file-input" accept=".json" multiple class="form-control">
                </div>
                <div class="filter-item">
                    <label for="date-filter">Filtrer par période</label>
                    <select id="date-filter" class="form-select">
                        <option value="all">Toutes les données</option>
                    </select>
                </div>
            </div>
            
            <div id="kpi-section">
                <div class="kpi-container">
                    <div class="kpi-card">
                        <div class="kpi-title">Ventes totales</div>
                        <div class="kpi-value" id="sales-count">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Chiffre d'affaires</div>
                        <div class="kpi-value" id="total-revenue">$0.00</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Produits vendus</div>
                        <div class="kpi-value" id="total-products">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Ticket moyen</div>
                        <div class="kpi-value" id="avg-ticket">$0.00</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Gráfico 1: Heatmap de días/horas -->
        <div class="mdc-card">
            <h2 class="mdc-card__title"><i class="fas fa-calendar-alt"></i> 1. Activité par Heure et Jour</h2>
            <div class="filter-container">
                <div class="filter-item">
                    <label for="heatmap-metric">Métrique à afficher</label>
                    <select id="heatmap-metric" class="form-select">
                        <option value="count">Nombre de ventes</option>
                        <option value="revenue">Chiffre d'affaires</option>
                    </select>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="heatmapChart"></canvas>
            </div>
        </div>
        
        <!-- Gráfico 2: Evolución diaria -->
        <div class="mdc-card">
            <h2 class="mdc-card__title"><i class="fas fa-chart-line"></i> 2. Évolution Quotidienne</h2>
            <div class="filter-container">
                <div class="filter-item">
                    <label for="trend-metric">Métrique</label>
                    <select id="trend-metric" class="form-select">
                        <option value="revenue">Chiffre d'affaires</option>
                        <option value="count">Nombre de ventes</option>
                        <option value="products">Produits vendus</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="trend-period">Période</label>
                    <select id="trend-period" class="form-select">
                        <option value="7">7 derniers jours</option>
                        <option value="14">14 derniers jours</option>
                        <option value="30">30 derniers jours</option>
                        <option value="all">Toute la période</option>
                    </select>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
        
        <!-- Gráfico 3: Distribución de tickets -->
        <div class="mdc-card">
            <h2 class="mdc-card__title"><i class="fas fa-money-bill-wave"></i> 3. Distribution des Tickets</h2>
            <div class="chart-container">
                <canvas id="ticketChart"></canvas>
            </div>
        </div>
        
        <!-- Gráfico 4: Productos por categoría -->
        <div class="mdc-card">
            <h2 class="mdc-card__title"><i class="fas fa-chart-pie"></i> 4. Répartition par Catégorie</h2>
            <div class="filter-container">
                <div class="filter-item">
                    <label for="category-metric">Métrique</label>
                    <select id="category-metric" class="form-select">
                        <option value="quantity">Quantité</option>
                        <option value="revenue">Chiffre d'affaires</option>
                    </select>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
        
        <!-- Gráfico 5: Top productos -->
        <div class="mdc-card">
            <h2 class="mdc-card__title"><i class="fas fa-star"></i> 5. Top 10 Produits</h2>
            <div class="filter-container">
                <div class="filter-item">
                    <label for="top-products-metric">Métrique</label>
                    <select id="top-products-metric" class="form-select">
                        <option value="quantity">Quantité vendue</option>
                        <option value="revenue">Chiffre d'affaires</option>
                    </select>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="topProductsChart"></canvas>
            </div>
        </div>
        
        <!-- Gráfico 6: Ticket promedio por hora -->
        <div class="mdc-card">
            <h2 class="mdc-card__title"><i class="fas fa-clock"></i> 6. Ticket Moyen par Heure</h2>
            <div class="chart-container">
                <canvas id="avgTicketChart"></canvas>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let salesData = [];
        let uploadedFiles = [];
        let charts = {};
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });
        
        function setupEventListeners() {
            document.getElementById('file-input').addEventListener('change', handleFileUpload);
            document.getElementById('date-filter').addEventListener('change', filterByDate);
            document.getElementById('heatmap-metric').addEventListener('change', updateHeatmap);
            document.getElementById('trend-metric').addEventListener('change', updateTrendChart);
            document.getElementById('trend-period').addEventListener('change', updateTrendChart);
            document.getElementById('category-metric').addEventListener('change', updateCategoryChart);
            document.getElementById('top-products-metric').addEventListener('change', updateTopProductsChart);
        }
        
        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            const filePromises = files.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const fileData = JSON.parse(e.target.result);
                            if (!Array.isArray(fileData)) {
                                throw new Error("Format de fichier invalide");
                            }
                            
                            // Extract date from first and last sale
                            const dates = fileData.map(sale => new Date(sale.date));
                            const minDate = new Date(Math.min(...dates));
                            const maxDate = new Date(Math.max(...dates));
                            
                            resolve({
                                name: file.name,
                                data: fileData,
                                minDate: minDate,
                                maxDate: maxDate
                            });
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.readAsText(file);
                });
            });
            
            Promise.all(filePromises)
                .then(fileContents => {
                    uploadedFiles = fileContents;
                    salesData = fileContents.flatMap(file => file.data);
                    
                    if (salesData.length === 0) throw new Error("Aucune donnée valide trouvée");
                    
                    updateDateFilter();
                    updateDataSummary();
                    renderAllCharts();
                })
                .catch(error => {
                    alert("Erreur: " + error.message);
                    console.error(error);
                });
        }
        
        function updateDateFilter() {
            const dateFilter = document.getElementById('date-filter');
            
            // Clear existing options except first
            while (dateFilter.options.length > 1) {
                dateFilter.remove(1);
            }
            
            // Add new options for each file
            uploadedFiles.forEach((file, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${file.name} (${file.minDate.toLocaleDateString('fr-FR')} - ${file.maxDate.toLocaleDateString('fr-FR')})`;
                dateFilter.appendChild(option);
            });
        }
        
        function filterByDate() {
            const selectedOption = document.getElementById('date-filter').value;
            
            if (selectedOption === 'all') {
                salesData = uploadedFiles.flatMap(file => file.data);
            } else {
                const fileIndex = parseInt(selectedOption);
                salesData = uploadedFiles[fileIndex].data;
            }
            
            updateDataSummary();
            updateAllCharts();
        }
        
        function updateDataSummary() {
            if (salesData.length === 0) {
                document.getElementById('kpi-section').style.display = 'none';
                return;
            }
            
            document.getElementById('kpi-section').style.display = 'block';
            
            // Calculate metrics
            const totalRevenue = salesData.reduce((sum, sale) => sum + sale.total, 0);
            const totalProducts = salesData.reduce((sum, sale) => 
                sum + sale.products.reduce((prodSum, product) => prodSum + product.quantity, 0), 0);
            const avgTicket = totalRevenue / salesData.length;
            
            // Update UI
            document.getElementById('sales-count').textContent = salesData.length.toLocaleString();
            document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('total-products').textContent = totalProducts.toLocaleString();
            document.getElementById('avg-ticket').textContent = `$${avgTicket.toFixed(2)}`;
        }
        
        function renderAllCharts() {
            renderHeatmapChart();
            renderTrendChart();
            renderTicketChart();
            renderCategoryChart();
            renderTopProductsChart();
            renderAvgTicketChart();
        }
        
        function updateAllCharts() {
            updateHeatmap();
            updateTrendChart();
            updateTicketChart();
            updateCategoryChart();
            updateTopProductsChart();
            updateAvgTicketChart();
        }
        
        // Gráfico 1: Heatmap de días/horas
        function renderHeatmapChart() {
            const ctx = document.getElementById('heatmapChart').getContext('2d');
            
            if (charts.heatmapChart) {
                charts.heatmapChart.destroy();
            }
            
            charts.heatmapChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const metric = document.getElementById('heatmap-metric').value;
                                    const value = context.raw;
                                    return metric === 'count' ? 
                                        `${value} ventes` : `$${value.toFixed(2)}`;
                                }
                            }
                        },
                        legend: { display: false },
                        zoom: { enabled: false }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Heure de la journée' },
                            grid: { display: false }
                        },
                        y: { 
                            title: { display: true, text: 'Jour de la semaine' },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            updateHeatmap();
        }
        
        function updateHeatmap() {
            const metric = document.getElementById('heatmap-metric').value;
            const heatmapData = prepareHeatmapData(metric);
            
            charts.heatmapChart.data.labels = heatmapData.labels;
            charts.heatmapChart.data.datasets = heatmapData.datasets;
            
            // Update colors based on metric
            const color = metric === 'count' ? 'rgba(54, 162, 235, 0.7)' : 'rgba(75, 192, 192, 0.7)';
            
            charts.heatmapChart.data.datasets.forEach(dataset => {
                dataset.backgroundColor = color;
                dataset.borderColor = color.replace('0.7', '1');
            });
            
            charts.heatmapChart.options.scales.y.title.text = metric === 'count' ? 
                'Nombre de ventes' : 'Chiffre d\'affaires ($)';
            
            charts.heatmapChart.update();
        }
        
        function prepareHeatmapData(metric) {
            const daysOfWeek = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            const hours = Array.from({length: 24}, (_, i) => `${i}h`);
            
            // Initialize data structure
            const data = {};
            daysOfWeek.forEach(day => {
                data[day] = Array(24).fill(0);
            });
            
            // Populate data
            salesData.forEach(sale => {
                const date = new Date(sale.date);
                const dayName = daysOfWeek[date.getDay()];
                const hour = date.getHours();
                
                if (metric === 'count') {
                    data[dayName][hour]++;
                } else {
                    data[dayName][hour] += sale.total;
                }
            });
            
            // Prepare datasets
            const datasets = daysOfWeek.map(day => ({
                label: day,
                data: data[day],
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                borderRadius: 4
            }));
            
            return {
                labels: hours,
                datasets: datasets
            };
        }
        
        // Gráfico 2: Evolución diaria
        function renderTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (charts.trendChart) {
                charts.trendChart.destroy();
            }
            
            charts.trendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const metric = document.getElementById('trend-metric').value;
                                    const value = context.raw;
                                    return metric === 'revenue' ? `$${value.toFixed(2)}` :
                                           metric === 'count' ? `${value} ventes` : `${value} produits`;
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'x'
                            },
                            pan: {
                                enabled: true,
                                mode: 'x'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Date' },
                            grid: { display: false }
                        },
                        y: { 
                            title: { display: true, text: 'Valeur' },
                            beginAtZero: true 
                        }
                    }
                }
            });
            
            updateTrendChart();
        }
        
        function updateTrendChart() {
            const metric = document.getElementById('trend-metric').value;
            const period = document.getElementById('trend-period').value;
            const trendData = prepareTrendData(metric, period);
            
            charts.trendChart.data.labels = trendData.labels;
            charts.trendChart.data.datasets = [{
                label: metric === 'revenue' ? 'Chiffre d\'affaires ($)' : 
                       metric === 'count' ? 'Nombre de ventes' : 'Produits vendus',
                data: trendData.values,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                tension: 0.1,
                fill: true
            }];
            
            charts.trendChart.options.scales.y.title.text = 
                metric === 'revenue' ? 'Chiffre d\'affaires ($)' : 
                metric === 'count' ? 'Nombre de ventes' : 'Produits vendus';
            
            charts.trendChart.update();
        }
        
        function prepareTrendData(metric, period) {
            const dailyData = {};
            
            // Determine date range based on period
            let cutoffDate = new Date();
            if (period !== 'all') {
                cutoffDate.setDate(cutoffDate.getDate() - parseInt(period));
            } else {
                cutoffDate = null;
            }
            
            salesData.forEach(sale => {
                const saleDate = new Date(sale.date);
                if (cutoffDate && saleDate < cutoffDate) return;
                
                const dateStr = saleDate.toLocaleDateString('fr-FR');
                if (!dailyData[dateStr]) {
                    dailyData[dateStr] = {
                        count: 0,
                        revenue: 0,
                        products: 0
                    };
                }
                
                dailyData[dateStr].count++;
                dailyData[dateStr].revenue += sale.total;
                dailyData[dateStr].products += sale.products.reduce((sum, p) => sum + p.quantity, 0);
            });
            
            // Sort dates
            const sortedDates = Object.keys(dailyData).sort((a, b) => 
                new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
            
            return {
                labels: sortedDates,
                values: sortedDates.map(date => 
                    metric === 'revenue' ? dailyData[date].revenue :
                    metric === 'count' ? dailyData[date].count :
                    dailyData[date].products)
            };
        }
        
        // Gráfico 3: Distribución de tickets
        function renderTicketChart() {
            const ctx = document.getElementById('ticketChart').getContext('2d');
            
            if (charts.ticketChart) {
                charts.ticketChart.destroy();
            }
            
            charts.ticketChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw} ventes`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Montant du ticket ($)' },
                            grid: { display: false }
                        },
                        y: { 
                            title: { display: true, text: 'Nombre de ventes' },
                            beginAtZero: true 
                        }
                    }
                }
            });
            
            updateTicketChart();
        }
        
        function updateTicketChart() {
            const ticketData = prepareTicketData();
            
            charts.ticketChart.data.labels = ticketData.labels;
            charts.ticketChart.data.datasets = [{
                label: 'Nombre de ventes',
                data: ticketData.counts,
                backgroundColor: 'rgba(153, 102, 255, 0.7)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1,
                borderRadius: 4
            }];
            
            charts.ticketChart.update();
        }
        
        function prepareTicketData() {
            const ranges = [
                { min: 0, max: 10, label: '0-10$' },
                { min: 10, max: 20, label: '10-20$' },
                { min: 20, max: 30, label: '20-30$' },
                { min: 30, max: 40, label: '30-40$' },
                { min: 40, max: 50, label: '40-50$' },
                { min: 50, max: 75, label: '50-75$' },
                { min: 75, max: 100, label: '75-100$' },
                { min: 100, max: Infinity, label: '100$+' }
            ];
            
            const counts = Array(ranges.length).fill(0);
            
            salesData.forEach(sale => {
                for (let i = 0; i < ranges.length; i++) {
                    if (sale.total >= ranges[i].min && sale.total < ranges[i].max) {
                        counts[i]++;
                        break;
                    }
                }
            });
            
            return {
                labels: ranges.map(r => r.label),
                counts: counts
            };
        }
        
        // Gráfico 4: Productos por categoría
        function renderCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (charts.categoryChart) {
                charts.categoryChart.destroy();
            }
            
            charts.categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const metric = document.getElementById('category-metric').value;
                                    const value = context.raw;
                                    return metric === 'quantity' ? 
                                        `${value} unités` : `$${value.toFixed(2)}`;
                                }
                            }
                        },
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                padding: 20
                            }
                        }
                    },
                    cutout: '65%'
                }
            });
            
            updateCategoryChart();
        }
        
        function updateCategoryChart() {
            const metric = document.getElementById('category-metric').value;
            const categoryData = prepareCategoryData(metric);
            
            charts.categoryChart.data.labels = categoryData.labels;
            charts.categoryChart.data.datasets = [{
                data: categoryData.values,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#8AC24A', '#F06292', '#7986CB', '#A1887F'
                ],
                borderWidth: 1
            }];
            
            charts.categoryChart.update();
        }
        
        function prepareCategoryData(metric) {
            const categories = {
                'Sandwichs': ['Barros Luco', 'Barros Pollo', 'Barros Jarpa'],
                'Salades': ['Salade Barros Luco'],
                'Viandes': ['Poulet', 'Boeuf'],
                'Accompagnements': ['Lentilles'],
                'Boissons': ['Jus de Fruits', 'Boissons Gazeuses Importées'],
                'Cafés': ['Café Filtre', 'Café au Lait'],
                'Desserts': ['Churro', 'Alfajor']
            };
            
            const categoryData = {};
            
            // Initialize categories
            Object.keys(categories).forEach(cat => {
                categoryData[cat] = 0;
            });
            
            // Calculate metrics
            salesData.forEach(sale => {
                sale.products.forEach(product => {
                    for (const [cat, products] of Object.entries(categories)) {
                        if (products.includes(product.name)) {
                            if (metric === 'quantity') {
                                categoryData[cat] += product.quantity;
                            } else {
                                categoryData[cat] += product.quantity * product.price;
                            }
                            break;
                        }
                    }
                });
            });
            
            // Filter out empty categories
            const filteredCategories = Object.entries(categoryData)
                .filter(([_, value]) => value > 0)
                .sort((a, b) => b[1] - a[1]);
            
            return {
                labels: filteredCategories.map(([cat]) => cat),
                values: filteredCategories.map(([_, value]) => value)
            };
        }
        
        // Gráfico 5: Top productos
        function renderTopProductsChart() {
            const ctx = document.getElementById('topProductsChart').getContext('2d');
            
            if (charts.topProductsChart) {
                charts.topProductsChart.destroy();
            }
            
            charts.topProductsChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const metric = document.getElementById('top-products-metric').value;
                                    const value = context.raw;
                                    return metric === 'quantity' ? 
                                        `${value} unités` : `$${value.toFixed(2)}`;
                                }
                            }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Valeur' },
                            beginAtZero: true 
                        },
                        y: { 
                            title: { display: true, text: 'Produit' },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            updateTopProductsChart();
        }
        
        function updateTopProductsChart() {
            const metric = document.getElementById('top-products-metric').value;
            const topProductsData = prepareTopProductsData(metric);
            
            charts.topProductsChart.data.labels = topProductsData.labels;
            charts.topProductsChart.data.datasets = [{
                label: metric === 'quantity' ? 'Quantité vendue' : 'Chiffre d\'affaires',
                data: topProductsData.values,
                backgroundColor: 'rgba(255, 159, 64, 0.7)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1,
                borderRadius: 4
            }];
            
            charts.topProductsChart.options.scales.x.title.text = 
                metric === 'quantity' ? 'Quantité vendue' : 'Chiffre d\'affaires ($)';
            
            charts.topProductsChart.update();
        }
        
        function prepareTopProductsData(metric) {
            const productSales = {};
            
            salesData.forEach(sale => {
                sale.products.forEach(product => {
                    if (!productSales[product.name]) {
                        productSales[product.name] = {
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    
                    productSales[product.name].quantity += product.quantity;
                    productSales[product.name].revenue += product.quantity * product.price;
                });
            });
            
            // Sort and get top 10
            const topProducts = Object.entries(productSales)
                .sort((a, b) => (metric === 'quantity' ? 
                    b[1].quantity - a[1].quantity : 
                    b[1].revenue - a[1].revenue))
                .slice(0, 10);
            
            return {
                labels: topProducts.map(([name]) => name),
                values: topProducts.map(([_, data]) => 
                    metric === 'quantity' ? data.quantity : data.revenue)
            };
        }
        
        // Gráfico 6: Ticket promedio por hora
        function renderAvgTicketChart() {
            const ctx = document.getElementById('avgTicketChart').getContext('2d');
            
            if (charts.avgTicketChart) {
                charts.avgTicketChart.destroy();
            }
            
            charts.avgTicketChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Heure' },
                            grid: { display: false }
                        },
                        y: { 
                            title: { display: true, text: 'Ticket moyen ($)' },
                            beginAtZero: true 
                        }
                    }
                }
            });
            
            updateAvgTicketChart();
        }
        
        function updateAvgTicketChart() {
            const avgTicketData = prepareAvgTicketData();
            
            charts.avgTicketChart.data.labels = Array.from({length: 24}, (_, i) => `${i}h`);
            charts.avgTicketChart.data.datasets = [{
                label: 'Ticket moyen ($)',
                data: avgTicketData,
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 2,
                tension: 0.1,
                fill: true
            }];
            
            charts.avgTicketChart.update();
        }
        
        function prepareAvgTicketData() {
            const hourlyTotals = Array(24).fill(0);
            const hourlyCounts = Array(24).fill(0);
            
            salesData.forEach(sale => {
                const hour = new Date(sale.date).getHours();
                hourlyTotals[hour] += sale.total;
                hourlyCounts[hour]++;
            });
            
            return hourlyTotals.map((total, i) => 
                hourlyCounts[i] > 0 ? parseFloat((total / hourlyCounts[i]).toFixed(2)) : 0);
        }
    </script>
</body>
</html>